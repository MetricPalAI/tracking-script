!function(e){if(e.ClientTracker)return;const t={supabaseUrl:"https://xgcebeqshnnrljqhxgmn.supabase.co",supabaseKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnY2ViZXFzaG5ucmxqcWh4Z21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEyNDQ4ODMsImV4cCI6MjA0NjgyMDg4M30.UwnpcDQ_DqkZkefkuYmZf2eXUWij5JlwMGVn4D5EE_Y",debug:e.location.search.includes("hsdebug=true"),batchSize:10,batchDelay:2e3,sessionTimeout:30,retryAttempts:3};let i,n=t,o=1,a=new Date,r=0,s=!1,c=new Date,l=!0,d=[];async function m(t,i,o="POST",a=0){try{const e=`${n.supabaseUrl}/rest/v1/${i}`,a="PATCH"===o?`${e}?id=eq.${t.id}`:`${e}?select=id`;n.debug&&console.log(`Attempting to send data to ${i}:`,t);const r=await fetch(a,{method:o,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.supabaseKey}`,apikey:n.supabaseKey,Prefer:"return=representation"},body:JSON.stringify(Array.isArray(t)?t:[t])});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const s=await r.json();return n.debug&&console.log(`Successfully sent data to ${i}:`,s),s}catch(r){if(n.debug&&console.error(`Failed to send data to ${i}:`,r),a<3)return await new Promise((e=>setTimeout(e,1e3*(a+1)))),m(t,i,o,a+1);const s=JSON.parse(localStorage.getItem("failed_events")||"[]");return s.push({eventData:t,table:i,method:o,timestamp:(new Date).toISOString()}),localStorage.setItem("failed_events",JSON.stringify(s)),await async function(t,i={}){const o={error_message:t.message,error_stack:t.stack,error_timestamp:(new Date).toISOString(),page_url:e.location.href,session_id:sessionStorage.getItem("mp_session_numeric_id"),visitor_id:sessionStorage.getItem("mp_visitor_id"),metadata:JSON.stringify({...i,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})};try{await m(o,"events","POST"),n.debug&&console.log("Error logged:",o)}catch(e){console.error("Failed to log error:",e);const t=JSON.parse(localStorage.getItem("failed_error_logs")||"[]");t.push(o),localStorage.setItem("failed_error_logs",JSON.stringify(t))}}(r,{operation:"sendTrackingData",table:i,method:o,retryCount:a,eventData:JSON.stringify(t)}),null}}function u(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"Tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"Mobile":"Desktop"}function g(){const t=new URLSearchParams(e.location.search),i={utm_source:t.get("utm_source"),utm_medium:t.get("utm_medium"),utm_campaign:t.get("utm_campaign"),utm_term:t.get("utm_term"),utm_content:t.get("utm_content")},n={gclid:t.get("gclid"),fbclid:t.get("fbclid"),ttclid:t.get("ttclid"),msclkid:t.get("msclkid")};return Object.values(i).some((e=>e))&&sessionStorage.setItem("utm_params",JSON.stringify(i)),{...i,click_id:Object.entries(n).find((([e,t])=>t))?.[1]||null,click_id_type:Object.entries(n).find((([e,t])=>t))?.[0]||null}}function f(e){if(!e)return"Other";return{cpc:"Paid Search",ppc:"Paid Search",paidsearch:"Paid Search","paid-search":"Paid Search","social-paid":"Paid Social","social-cpc":"Paid Social",social_paid:"Paid Social",display:"Paid Display",banner:"Paid Display",cpm:"Paid Display",email:"Email","e-mail":"Email",newsletter:"Email",social:"Social Media","social-organic":"Social Media",affiliate:"Affiliates",partner:"Affiliates",organic:"Organic Search",referral:"Referral",direct:"Direct"}[e.toLowerCase()]||"Other"}async function _(){const e=function(){const e={userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,screenResolution:`${screen.width}x${screen.height}`,screenDepth:screen.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};return Object.values(e).join("|")}();let t=sessionStorage.getItem("mp_visitor_id");if(t)return console.log("Returning visitor from session:",t),{id:t,fingerprint:e,isNew:!1};if(t=localStorage.getItem("mp_visitor_id"),t)return console.log("Returning visitor from local storage:",t),await m({id:t,last_seen_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"visitors","PATCH"),{id:t,fingerprint:e,isNew:!1};const i={first_fingerprint_id:e,first_seen_at:(new Date).toISOString(),last_seen_at:(new Date).toISOString(),additional_fingerprints:[]},n=await m(i,"visitors");return n&&n[0]?.id?(t=n[0].id,sessionStorage.setItem("mp_visitor_id",t),localStorage.setItem("mp_visitor_id",t),console.log("New visitor created:",t),{id:t,fingerprint:e,isNew:!0}):(console.error("Failed to create or identify visitor"),null)}function p(){document.addEventListener("submit",(async function(t){const i=t.target,o=Array.from(i.elements).find((e=>"email"===e.type||e.name?.toLowerCase().includes("email")||e.id?.toLowerCase().includes("email"))),a=Array.from(i.elements).find((e=>e.name?.toLowerCase().includes("company")||e.name?.toLowerCase().includes("organization")||e.id?.toLowerCase().includes("company")||e.id?.toLowerCase().includes("organization"))),r=o?.value?.trim(),s=a?.value?.trim();let c=null,l=!1;if(r){c=r.split("@")[1]?.toLowerCase();l=c&&!["gmail.com","yahoo.com","hotmail.com","outlook.com","aol.com"].includes(c)}const d=sessionStorage.getItem("mp_visitor_id");if(r&&d){const e={id:d,email:r,email_domain:c,is_identified:!0,identification_date:(new Date).toISOString(),identification_source:"form_submission",updated_at:(new Date).toISOString()};try{await m(e,"visitors","PATCH"),console.log("Visitor identified:",d),l&&await async function(e,t,i,o){try{const a=await async function(e){try{const t=await fetch(`${n.supabaseUrl}/rest/v1/companies?domain=eq.${e}&select=id`,{headers:{Authorization:`Bearer ${n.supabaseKey}`,apikey:n.supabaseKey}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json())[0]}catch(e){return console.error("Error finding company:",e),null}}(e);if(a)await m({id:a.id,last_enrichment_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"companies","PATCH"),await m({id:i,company_id:a.id,updated_at:(new Date).toISOString()},"visitors","PATCH");else{const n={domain:e,name:t||e.split(".")[0],identified_via:"form_submission",identified_at:(new Date).toISOString(),status:"identified",company_data:JSON.stringify({first_visitor_id:i,first_seen_email:o})},a=await m(n,"companies");a?.[0]?.id&&await m({id:i,company_id:a[0].id,updated_at:(new Date).toISOString()},"visitors","PATCH")}}catch(e){console.error("Error handling company identification:",e)}}(c,s,d,r)}catch(e){console.error("Error identifying visitor:",e)}}const u={session_id:parseInt(sessionStorage.getItem("mp_session_numeric_id")),visitor_id:d,form_id:i.id||null,form_name:i.getAttribute("name")||null,form_action:i.action,page_url:e.location.href,email_domain:c,email:r,is_business_email:l,form_fields:JSON.stringify({has_company_field:!!a,has_email_field:!!o,company_name:s||null}),metadata:JSON.stringify({form_type:y(i),field_count:i.elements.length,has_required_fields:Array.from(i.elements).some((e=>e.required))})};try{await m(u,"form_submissions"),h("form_complete","FORM",i.id,{formType:y(i),hasEmail:!!o,hasCompany:!!a,isBusinessEmail:l})}catch(e){console.error("Error tracking form submission:",e)}})),document.addEventListener("change",(function(e){const t=e.target;t.form&&h("form_field_complete",t.tagName,t.id,{fieldType:t.type,fieldName:t.name,isRequired:t.required,formId:t.form.id,formType:y(t.form)})}))}function h(t,i=null,n=null,a={}){m({session_id:o,event_type:t,event_timestamp:(new Date).toISOString(),page_url:e.location.href,element_type:i,element_id:n,other_data:JSON.stringify({...a,tab_active:l,time_since_last_activity:c?(new Date-c)/1e3:0,active_tab_time:0,session_ending:s})},"events")}function S(){let t=0;e.addEventListener("scroll",function(e,t){let i;return function(...n){clearTimeout(i),i=setTimeout((()=>e.apply(this,n)),t)}}((function(){const i=function(){const t=e.innerHeight,i=document.documentElement.scrollHeight,n=e.pageYOffset||document.documentElement.scrollTop;return Math.round((n+t)/i*100)}();i>r&&(r=i,Math.floor(i/25)>Math.floor(t/25)&&(h("scroll_depth",null,null,{depth:25*Math.floor(i/25)}),t=i))}),200))}function y(e){const t=e.outerHTML.toLowerCase();return t.includes("contact")||e.id?.toLowerCase().includes("contact")?"contact":t.includes("subscribe")||t.includes("newsletter")?"newsletter":t.includes("demo")||t.includes("trial")?"demo":"other"}async function v(){try{const t=await _();if(!t)return void(n.debug&&console.error("Failed to identify visitor"));console.log(`Visitor identified: ${t.id}`),sessionStorage.setItem("mp_visitor_id",t.id),o=Math.floor(1e9*Math.random()),console.log(`Generated session numeric ID: ${o}`);const y=g();console.log("Retrieved URL Parameters:",y);const v=function(){const e=sessionStorage.getItem("utm_params");if(e){const t=JSON.parse(e);if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:f(t.utm_medium)}}const t=g();if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:f(t.utm_medium)};const i=document.referrer;if(!i)return{source:"direct",medium:"none",channel:"direct"};try{const e=new URL(i).hostname,t={google:{medium:"organic",channel:"Organic Search"},bing:{medium:"organic",channel:"Organic Search"},yahoo:{medium:"organic",channel:"Organic Search"},duckduckgo:{medium:"organic",channel:"Organic Search"}},n={"facebook.com":{medium:"social",channel:"Social Media"},"instagram.com":{medium:"social",channel:"Social Media"},"linkedin.com":{medium:"social",channel:"Social Media"},"twitter.com":{medium:"social",channel:"Social Media"},"t.co":{medium:"social",channel:"Social Media"},"tiktok.com":{medium:"social",channel:"Social Media"}};for(const[i,n]of Object.entries(t))if(e.includes(i))return{source:i.charAt(0).toUpperCase()+i.slice(1),medium:n.medium,channel:n.channel};for(const[t,i]of Object.entries(n))if(e.includes(t))return{source:t.split(".")[0].charAt(0).toUpperCase()+t.split(".")[0].slice(1),medium:i.medium,channel:i.channel};return{source:e,medium:"referral",channel:"Referral"}}catch(e){return console.error("Error parsing referrer:",e),{source:"direct",medium:"none",channel:"direct"}}}();console.log("Traffic Information:",v);const w={fingerprint_id:t.fingerprint,visitor_id:t.id,session_start:(new Date).toISOString(),entry_page_url:e.location.href,traffic_source:v.source,traffic_medium:v.medium,traffic_channel:v.channel,device_type:u(),country:Intl.DateTimeFormat().resolvedOptions().timeZone,click_id:y.click_id||null},b=await m(w,"sessions");if(!b?.[0]?.id)return void console.error("Failed to create session");const I=b[0].id;console.log(`Session created with UUID: ${I}`),sessionStorage.setItem("mp_session_uuid",I),sessionStorage.setItem("mp_session_numeric_id",o.toString());if(["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].some((e=>y[e]))){const e={session_id:o,utm_source:y.utm_source,utm_medium:y.utm_medium,utm_campaign:y.utm_campaign,utm_term:y.utm_term,utm_content:y.utm_content};console.log("Storing UTM parameters:",e),await m(e,"utmparameters")}const O={session_id:o,page_url:e.location.href,visit_timestamp:(new Date).toISOString(),page_type:"page"};console.log("Recording initial page visit:",O),await m(O,"pagevisits"),p(),document.addEventListener("click",(function(e){const t=e.target.closest("a");if(!t)return;const i=t.href||"";[".pdf",".doc",".docx",".xls",".xlsx",".zip",".rar"].some((e=>i.toLowerCase().endsWith(e)))&&h("file_download","LINK",t.id,{fileName:i.split("/").pop(),fileType:i.split(".").pop().toLowerCase()})})),document.addEventListener("play",(function(e){"VIDEO"===e.target.tagName&&h("video_play","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,videoDuration:e.target.duration})}),!0),document.addEventListener("pause",(function(e){"VIDEO"===e.target.tagName&&h("video_pause","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,timeStamp:e.target.currentTime})}),!0),S(),document.addEventListener("visibilitychange",(()=>{l="visible"===document.visibilityState,l&&(c=new Date,s&&(s=!1,console.log("Session restored due to user activity")))})),["mousedown","keydown","scroll","touchstart"].forEach((e=>{document.addEventListener(e,(()=>{c=new Date,s&&(s=!1,console.log("Session restored due to user activity"))}))})),i=setInterval((()=>{if(!l)return;const e=(new Date-c)/1e3/60;e>=10&&!s&&(s=!0,h("session_inactive",null,null,{inactiveTime:e}))}),6e4),setInterval((function(){l&&h("time_on_page",null,null,{seconds:Math.round((new Date-a)/1e3),isActive:!0})}),3e4),setInterval((async()=>{if(!navigator.onLine)return;const e=JSON.parse(localStorage.getItem("failed_error_logs")||"[]");if(e.length>0){const t=[];for(const i of e)try{await m(i,"events","POST"),t.push(i)}catch(e){console.error("Failed to resend error log:",e)}localStorage.setItem("failed_error_logs",JSON.stringify(e.filter((e=>!t.includes(e)))))}const t=JSON.parse(localStorage.getItem("failed_events")||"[]");if(t.length>0){const e=[];for(const i of t)try{await m(i.eventData,i.table,i.method),e.push(i)}catch(e){console.error("Failed to resend event:",e)}localStorage.setItem("failed_events",JSON.stringify(t.filter((t=>!e.includes(t)))))}}),6e4),document.addEventListener("click",(function(e){const t=e.target.closest('a, button, [role="button"], input[type="submit"]');if(t){const e={type:t.tagName.toLowerCase(),id:t.id||"",text:t.innerText||t.value||"",href:t.href||"",classes:t.className};(t.closest("[data-track]")||e.href||"submit"===e.type||e.classes.includes("cta")||e.classes.includes("btn-primary"))&&h("click",e.type,e.id,{text:e.text,href:e.href})}})),e.addEventListener("beforeunload",(function(){console.log("Session ending, tracking session end data...");const t={id:I,session_end:(new Date).toISOString(),exit_page_url:e.location.href,other_data:JSON.stringify({total_active_time:0,final_scroll_depth:r,tab_switches:0,last_active:c.toISOString(),inactivity_periods:d})};try{navigator.sendBeacon(`${n.supabaseUrl}/rest/v1/sessions`,JSON.stringify({...t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.supabaseKey}`,apikey:n.supabaseKey}})),console.log("Session end data successfully sent using sendBeacon.")}catch(e){console.error("Failed to send session end data using sendBeacon:",e)}h("final_scroll_depth",null,null,{depth:r})})),console.log("Tracking initialized with session:",I)}catch(e){n.debug&&console.error("Error during startTracking:",e)}}function w(e={}){try{if(n={...t,...e},!n.supabaseUrl||!n.supabaseKey)throw new Error("Supabase URL and API key are required");v().catch((e=>{n.debug&&console.error("Tracking initialization failed:",e)}))}catch(e){console.error("Fatal initialization error:",e)}}if(e.initializeClientTracker=w,e.ClientTracker={init:w,track:function(e,t){h(e,null,null,t)}},e.google_tag_manager)try{const t=e.dataLayer?.find((e=>e.trackerConfig))?.trackerConfig;t&&w(t)}catch(e){console.error("GTM initialization error:",e)}}(window);
