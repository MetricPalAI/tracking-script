!function(e){if(e.ClientTracker)return;const t={supabaseUrl:"https://lwyxvzvyvpqhuocfcbwd.supabase.co",supabaseKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3eXh2enZ5dnBxaHVvY2ZjYndkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc1MTUwNTYsImV4cCI6MjA0MzA5MTA1Nn0.WYwNg-BHhIdbj7pcCuBnqc8-c9NU5sR8hPQLDlGY9RY",debug:e.location.search.includes("hsdebug=true"),batchSize:10,batchDelay:2e3,sessionTimeout:30,retryAttempts:3};let i,n=t,o=new Date,a=0,r=!1,s=new Date,c=!0,l=[];async function d(t,i,o="POST",a=0){try{const e=`${n.supabaseUrl}/rest/v1/${i}`,a="PATCH"===o?`${e}?id=eq.${t.id}`:`${e}?select=id`;n.debug&&console.log(`Attempting to send data to ${i}:`,t);const r=await fetch(a,{method:o,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.supabaseKey}`,apikey:n.supabaseKey,Prefer:"return=representation"},body:JSON.stringify(Array.isArray(t)?t:[t])});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const s=await r.json();return n.debug&&console.log(`Successfully sent data to ${i}:`,s),s}catch(r){if(n.debug&&console.error(`Failed to send data to ${i}:`,r),a<3)return await new Promise((e=>setTimeout(e,1e3*(a+1)))),d(t,i,o,a+1);const s=JSON.parse(localStorage.getItem("failed_events")||"[]");return s.push({eventData:t,table:i,method:o,timestamp:(new Date).toISOString()}),localStorage.setItem("failed_events",JSON.stringify(s)),await async function(t,i={}){const o={error_message:t.message,error_stack:t.stack,error_timestamp:(new Date).toISOString(),page_url:e.location.href,session_uuid:sessionStorage.getItem("mp_session_id"),visitor_id:sessionStorage.getItem("mp_visitor_id"),metadata:JSON.stringify({...i,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})};try{await d(o,"events","POST"),n.debug&&console.log("Error logged:",o)}catch(e){console.error("Failed to log error:",e);const t=JSON.parse(localStorage.getItem("failed_error_logs")||"[]");t.push(o),localStorage.setItem("failed_error_logs",JSON.stringify(t))}}(r,{operation:"sendTrackingData",table:i,method:o,retryCount:a,eventData:JSON.stringify(t)}),null}}function u(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"Tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"Mobile":"Desktop"}function m(){const t=new URLSearchParams(e.location.search),i={utm_source:t.get("utm_source"),utm_medium:t.get("utm_medium"),utm_campaign:t.get("utm_campaign"),utm_term:t.get("utm_term"),utm_content:t.get("utm_content")},n={gclid:t.get("gclid"),fbclid:t.get("fbclid"),ttclid:t.get("ttclid"),msclkid:t.get("msclkid")};return Object.values(i).some((e=>e))&&sessionStorage.setItem("utm_params",JSON.stringify(i)),{...i,click_id:Object.entries(n).find((([e,t])=>t))?.[1]||null,click_id_type:Object.entries(n).find((([e,t])=>t))?.[0]||null}}function g(e){if(!e)return"Other";return{cpc:"Paid Search",ppc:"Paid Search",paidsearch:"Paid Search","paid-search":"Paid Search","social-paid":"Paid Social","social-cpc":"Paid Social",social_paid:"Paid Social",display:"Paid Display",banner:"Paid Display",cpm:"Paid Display",email:"Email","e-mail":"Email",newsletter:"Email",social:"Social Media","social-organic":"Social Media",affiliate:"Affiliates",partner:"Affiliates",organic:"Organic Search",referral:"Referral",direct:"Direct"}[e.toLowerCase()]||"Other"}async function f(){const e=function(){const e={userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,screenResolution:`${screen.width}x${screen.height}`,screenDepth:screen.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};return Object.values(e).join("|")}();let t=sessionStorage.getItem("mp_visitor_id");if(t)return console.log("Returning visitor from session:",t),{id:t,fingerprint:e,isNew:!1};if(t=localStorage.getItem("mp_visitor_id"),t)return console.log("Returning visitor from local storage:",t),await d({id:t,last_seen_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"visitors","PATCH"),{id:t,fingerprint:e,isNew:!1};const i={first_fingerprint_id:e,first_seen_at:(new Date).toISOString(),last_seen_at:(new Date).toISOString(),additional_fingerprints:[]},n=await d(i,"visitors");return n&&n[0]?.id?(t=n[0].id,sessionStorage.setItem("mp_visitor_id",t),localStorage.setItem("mp_visitor_id",t),console.log("New visitor created:",t),{id:t,fingerprint:e,isNew:!0}):(console.error("Failed to create or identify visitor"),null)}async function _(t,i=null,n=null,o={}){const a=await T();if(!a)return;return d({session_uuid:a,event_type:t,event_timestamp:(new Date).toISOString(),page_url:e.location.href,element_type:i,element_id:n,other_data:JSON.stringify({...o,tab_active:c,time_since_last_activity:s?(new Date-s)/1e3:0,active_tab_time:0,session_ending:r})},"events")}function p(){document.addEventListener("submit",(async function(t){const i=t.target,o=Array.from(i.elements).find((e=>"email"===e.type||e.name?.toLowerCase().includes("email")||e.id?.toLowerCase().includes("email"))),a=Array.from(i.elements).find((e=>e.name?.toLowerCase().includes("company")||e.name?.toLowerCase().includes("organization")||e.id?.toLowerCase().includes("company")||e.id?.toLowerCase().includes("organization"))),r=o?.value?.trim(),s=a?.value?.trim();let c=null,l=!1;if(r){c=r.split("@")[1]?.toLowerCase();l=c&&!["gmail.com","yahoo.com","hotmail.com","outlook.com","aol.com"].includes(c)}const u=sessionStorage.getItem("mp_visitor_id");if(r&&u){const e={id:u,email:r,email_domain:c,is_identified:!0,identification_date:(new Date).toISOString(),identification_source:"form_submission",updated_at:(new Date).toISOString()};try{await d(e,"visitors","PATCH"),console.log("Visitor identified:",u),l&&await async function(e,t,i,o){try{const a=await async function(e){try{const t=await fetch(`${n.supabaseUrl}/rest/v1/companies?domain=eq.${e}&select=id`,{headers:{Authorization:`Bearer ${n.supabaseKey}`,apikey:n.supabaseKey}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json())[0]}catch(e){return console.error("Error finding company:",e),null}}(e);if(a)await d({id:a.id,last_enrichment_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"companies","PATCH"),await d({id:i,company_id:a.id,updated_at:(new Date).toISOString()},"visitors","PATCH");else{const n={domain:e,name:t||e.split(".")[0],identified_via:"form_submission",identified_at:(new Date).toISOString(),status:"identified",company_data:JSON.stringify({first_visitor_id:i,first_seen_email:o})},a=await d(n,"companies");a?.[0]?.id&&await d({id:i,company_id:a[0].id,updated_at:(new Date).toISOString()},"visitors","PATCH")}}catch(e){console.error("Error handling company identification:",e)}}(c,s,u,r)}catch(e){console.error("Error identifying visitor:",e)}}const m={session_uuid:sessionStorage.getItem("mp_session_id"),visitor_id:sessionStorage.getItem("mp_visitor_id"),form_id:i.id||null,form_name:i.getAttribute("name")||null,form_action:i.action,page_url:e.location.href,email_domain:c,email:r,is_business_email:l,form_fields:JSON.stringify({has_company_field:!!a,has_email_field:!!o,company_name:s||null}),metadata:JSON.stringify({form_type:D(i),field_count:i.elements.length,has_required_fields:Array.from(i.elements).some((e=>e.required))})};try{await d(m,"form_submissions"),_("form_complete","FORM",i.id,{formType:D(i),hasEmail:!!o,hasCompany:!!a,isBusinessEmail:l})}catch(e){console.error("Error tracking form submission:",e)}})),document.addEventListener("change",(function(e){const t=e.target;t.form&&_("form_field_complete",t.tagName,t.id,{fieldType:t.type,fieldName:t.name,isRequired:t.required,formId:t.form.id,formType:D(t.form)})}))}function h(){document.addEventListener("click",(function(e){const t=e.target.closest("a");if(!t)return;const i=t.href||"";[".pdf",".doc",".docx",".xls",".xlsx",".zip",".rar"].some((e=>i.toLowerCase().endsWith(e)))&&_("file_download","LINK",t.id,{fileName:i.split("/").pop(),fileType:i.split(".").pop().toLowerCase()})}))}function S(){document.addEventListener("play",(function(e){"VIDEO"===e.target.tagName&&_("video_play","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,videoDuration:e.target.duration})}),!0),document.addEventListener("pause",(function(e){"VIDEO"===e.target.tagName&&_("video_pause","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,timeStamp:e.target.currentTime})}),!0)}function y(){let t=0;e.addEventListener("scroll",function(e,t){let i;return function(...n){clearTimeout(i),i=setTimeout((()=>e.apply(this,n)),t)}}((function(){const i=function(){const t=e.innerHeight,i=document.documentElement.scrollHeight,n=e.pageYOffset||document.documentElement.scrollTop;return Math.round((n+t)/i*100)}();i>a&&(a=i,Math.floor(i/25)>Math.floor(t/25)&&(_("scroll_depth",null,null,{depth:25*Math.floor(i/25)}),t=i))}),200))}function v(){document.addEventListener("visibilitychange",(()=>{c="visible"===document.visibilityState,c&&(s=new Date,r&&(r=!1,console.log("Session restored due to user activity")))}));["mousedown","keydown","scroll","touchstart"].forEach((e=>{document.addEventListener(e,(()=>{s=new Date,r&&(r=!1,console.log("Session restored due to user activity"))}))})),i=setInterval((()=>{if(!c)return;const e=(new Date-s)/1e3/60;e>=10&&!r&&(r=!0,_("session_inactive",null,null,{inactiveTime:e}))}),6e4)}let w=0,b=Date.now();function I(){setInterval((function(){if(c){const e=Date.now();w+=e-b,b=e}}),1e3),setInterval((function(){c&&_("page_time_checkpoint",null,null,{activeTime:Math.round(w/1e3),totalTime:Math.round((Date.now()-o)/1e3)})}),3e5)}function O(){setInterval((async()=>{if(!navigator.onLine)return;const e=JSON.parse(localStorage.getItem("failed_error_logs")||"[]");if(e.length>0){const t=[];for(const i of e)try{await d(i,"events","POST"),t.push(i)}catch(e){console.error("Failed to resend error log:",e)}localStorage.setItem("failed_error_logs",JSON.stringify(e.filter((e=>!t.includes(e)))))}const t=JSON.parse(localStorage.getItem("failed_events")||"[]");if(t.length>0){const e=[];for(const i of t)try{await d(i.eventData,i.table,i.method),e.push(i)}catch(e){console.error("Failed to resend event:",e)}localStorage.setItem("failed_events",JSON.stringify(t.filter((t=>!e.includes(t)))))}}),6e4)}function D(e){const t=e.outerHTML.toLowerCase();return t.includes("contact")||e.id?.toLowerCase().includes("contact")?"contact":t.includes("subscribe")||t.includes("newsletter")?"newsletter":t.includes("demo")||t.includes("trial")?"demo":"other"}async function T(){try{const t=await f();if(!t)return n.debug&&console.error("Failed to identify visitor"),null;console.log(`Visitor identified: ${t.id}`),sessionStorage.setItem("mp_visitor_id",t.id);const i=sessionStorage.getItem("mp_session_id");if(i)return console.log(`Reusing existing session: ${i}`),i;const r=m(),b=function(){const e=sessionStorage.getItem("utm_params");if(e){const t=JSON.parse(e);if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:g(t.utm_medium)}}const t=m();if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:g(t.utm_medium)};const i=document.referrer;if(!i)return{source:"direct",medium:"none",channel:"direct"};try{const e=new URL(i).hostname,t={google:{medium:"organic",channel:"Organic Search"},bing:{medium:"organic",channel:"Organic Search"},yahoo:{medium:"organic",channel:"Organic Search"},duckduckgo:{medium:"organic",channel:"Organic Search"}},n={"facebook.com":{medium:"social",channel:"Social Media"},"instagram.com":{medium:"social",channel:"Social Media"},"linkedin.com":{medium:"social",channel:"Social Media"},"twitter.com":{medium:"social",channel:"Social Media"},"t.co":{medium:"social",channel:"Social Media"},"tiktok.com":{medium:"social",channel:"Social Media"}};for(const[i,n]of Object.entries(t))if(e.includes(i))return{source:i.charAt(0).toUpperCase()+i.slice(1),medium:n.medium,channel:n.channel};for(const[t,i]of Object.entries(n))if(e.includes(t))return{source:t.split(".")[0].charAt(0).toUpperCase()+t.split(".")[0].slice(1),medium:i.medium,channel:i.channel};return{source:e,medium:"referral",channel:"Referral"}}catch(e){return console.error("Error parsing referrer:",e),{source:"direct",medium:"none",channel:"direct"}}}(),D={fingerprint_id:t.fingerprint,visitor_id:t.id,session_start:(new Date).toISOString(),entry_page_url:e.location.href,traffic_source:b.source,traffic_medium:b.medium,traffic_channel:b.channel,device_type:u(),country:Intl.DateTimeFormat().resolvedOptions().timeZone,click_id:r.click_id||null},T=await d(D,"sessions");if(!T?.[0]?.id)return console.error("Failed to create session"),null;const k=T[0].id;if(console.log(`Session created with UUID: ${k}`),sessionStorage.setItem("mp_session_id",k),Object.values(r).some((e=>e?.startsWith("utm_")))){const e={session_uuid:k,utm_source:r.utm_source,utm_medium:r.utm_medium,utm_campaign:r.utm_campaign,utm_term:r.utm_term,utm_content:r.utm_content};console.log("Storing UTM parameters:",e),await d(e,"utmparameters")}const N={session_uuid:k,page_url:e.location.href,visit_timestamp:(new Date).toISOString(),page_type:"page"};return console.log("Recording initial page visit:",N),await d(N,"pagevisits"),p(),h(),S(),y(),v(),I(),O(),document.addEventListener("click",(function(e){const t=e.target.closest('a, button, [role="button"], input[type="submit"]');if(t){const e={type:t.tagName.toLowerCase(),id:t.id||"",text:t.innerText||t.value||"",href:t.href||"",classes:t.className};(t.closest("[data-track]")||e.href||"submit"===e.type||e.classes.includes("cta")||e.classes.includes("btn-primary"))&&_("click",e.type,e.id,{text:e.text,href:e.href})}})),e.addEventListener("beforeunload",(function(){const t=sessionStorage.getItem("mp_session_id");if(!t)return;console.log("Session ending, tracking session end data..."),_("page_time_summary",null,null,{activeTime:Math.round(w/1e3),totalTime:Math.round((Date.now()-o)/1e3),isActive:c}),_("final_scroll_depth",null,null,{depth:a});const i={id:t,session_end:(new Date).toISOString(),exit_page_url:e.location.href,other_data:JSON.stringify({total_active_time:Math.round(w/1e3),total_time:Math.round((Date.now()-o)/1e3),final_scroll_depth:a,tab_switches:0,last_active:s.toISOString(),inactivity_periods:l,is_tab_active:c})};try{navigator.sendBeacon(`${n.supabaseUrl}/rest/v1/sessions`,JSON.stringify({...i,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.supabaseKey}`,apikey:n.supabaseKey}})),console.log("Session end data successfully sent using sendBeacon.")}catch(e){console.error("Failed to send session end data using sendBeacon:",e)}})),console.log("Tracking initialized with session:",k),k}catch(e){return n.debug&&console.error("Error during startTracking:",e),null}}function k(e={}){try{if(n={...t,...e},!n.supabaseUrl||!n.supabaseKey)throw new Error("Supabase URL and API key are required");p(),h(),S(),y(),v(),I(),O(),T().catch((e=>{n.debug&&console.error("Tracking initialization failed:",e)}))}catch(e){console.error("Fatal initialization error:",e)}}if(e.initializeClientTracker=k,e.ClientTracker={init:k,track:function(e,t){_(e,null,null,t)}},e.google_tag_manager)try{const t=e.dataLayer?.find((e=>e.trackerConfig))?.trackerConfig;t&&k(t)}catch(e){console.error("GTM initialization error:",e)}}(window);
