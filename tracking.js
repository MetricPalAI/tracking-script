!function(e){if(e.MetricPal&&e.MetricPal.initialized)return e.MetricPal;e.clientTrackerQueue=e.clientTrackerQueue||[];const t=document.currentScript||document.querySelector('script[src*="tracking.js"]'),i=t?.getAttribute("apikey")||t?.getAttribute("data-apikey"),n={supabaseUrl:"https://lwyxvzvyvpqhuocfcbwd.supabase.co",supabaseKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3eXh2enZ5dnBxaHVvY2ZjYndkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc1MTUwNTYsImV4cCI6MjA0MzA5MTA1Nn0.WYwNg-BHhIdbj7pcCuBnqc8-c9NU5sR8hPQLDlGY9RY",debug:e.location.search.includes("mpdebug=true")||!1,batchSize:10,batchDelay:2e3,sessionTimeout:30,retryAttempts:3,apiKey:i};function r(...e){s.debug&&console.log("[MetricPal Debug]:",...e)}function a(e){try{const t=new URL(e);return t.origin+t.pathname+t.hash}catch(t){return e}}let o,s=n,c=new Date,l=0,d=!1,u=new Date,m=!0,g=[];const _=["gmail.com","yahoo.com","hotmail.com","outlook.com","aol.com","icloud.com","protonmail.com","mail.com"],f=[];let p;const h="mp_session_id",y="mp_session_start",w="mp_visitor_id",v={sessions:{pk:"id",data_type:"uuid"},visitors:{pk:"id",data_type:"uuid"},companies:{pk:"id",data_type:"uuid"},touchpoints:{pk:"id",data_type:"uuid"},visitor_companies:{pk:"id",data_type:"uuid"},form_submissions:{pk:"id",data_type:"uuid"}};let S=null;async function b(e,t,i="POST",n=0){try{const a=await async function(e){if(S)return S;try{const t=await fetch(`${s.supabaseUrl}/rest/v1/api_keys?key=eq.${e}&select=id`,{method:"GET",headers:{Authorization:`Bearer ${s.supabaseKey}`,apikey:s.supabaseKey}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const i=await t.json();if(!i||!i[0]||!i[0].id)throw new Error("Invalid API key");return S=i[0].id,S}catch(e){throw console.error("API key validation failed:",e),e}}(s.apiKey),o=`${s.supabaseUrl}/rest/v1/${t}`,c="PATCH"===i?`${o}?id=eq.${e.id}`:o,l={method:i,headers:{Authorization:`Bearer ${s.supabaseKey}`,apikey:s.supabaseKey}};if("GET"!==i){let n=e;"POST"===i&&v[t]?n=Array.isArray(e)?e.map((e=>({id:crypto.randomUUID(),tenant_id:a,...e}))):{id:crypto.randomUUID(),tenant_id:a,...e}:e&&(n=Array.isArray(e)?e.map((e=>({...e,tenant_id:a}))):{...e,tenant_id:a}),l.headers["Content-Type"]="application/json",l.headers.Prefer="POST"===i?"return=representation":"return=minimal",l.body=JSON.stringify(Array.isArray(n)?n:[n])}s.debug&&console.log(`Attempting to send data to ${t}:`,e);const d=await fetch(c,l);if(!d.ok){const e=await d.text();throw new Error(`HTTP error! status: ${d.status}, message: ${e}`)}if("GET"===i||"POST"===i||d.headers.get("content-type")?.includes("application/json"))try{const e=await d.json();return r(`Successfully sent data to ${t}:`,e),e}catch(n){if("PATCH"===i&&204===d.status)return r(`Successfully updated ${t}`),[{id:e.id}];throw new Error(`Failed to parse response: ${n.message}`)}return"PATCH"===i&&204===d.status?[{id:e.id}]:null}catch(r){if(s.debug&&console.error(`Failed to send data to ${t}:`,r),n<3)return await new Promise((e=>setTimeout(e,1e3*(n+1)))),b(e,t,i,n+1);console.error("Failed after all retries:",{table:t,data:e,error:r.message});const a=JSON.parse(localStorage.getItem("failed_events")||"[]");return a.push({eventData:e,table:t,method:i,timestamp:(new Date).toISOString()}),localStorage.setItem("failed_events",JSON.stringify(a)),null}}function I(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"Tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"Mobile":"Desktop"}function k(){const t=new URLSearchParams(e.location.search),i={utm_source:t.get("utm_source"),utm_medium:t.get("utm_medium"),utm_campaign:t.get("utm_campaign"),utm_term:t.get("utm_term"),utm_content:t.get("utm_content")},n={gclid:t.get("gclid"),fbclid:t.get("fbclid"),ttclid:t.get("ttclid"),msclkid:t.get("msclkid")};return Object.values(i).some((e=>e))&&(sessionStorage.setItem("utm_params",JSON.stringify(i)),console.log("UTM parameters stored in session:",i)),{...i,click_id:Object.entries(n).find((([e,t])=>t))?.[1]||null,click_id_type:Object.entries(n).find((([e,t])=>t))?.[0]||null}}function O(e){return e&&{cpc:"Paid Search",ppc:"Paid Search",paidsearch:"Paid Search","paid-search":"Paid Search","social-paid":"Paid Social","social-cpc":"Paid Social",social_paid:"Paid Social",display:"Paid Display",banner:"Paid Display",cpm:"Paid Display",email:"Email","e-mail":"Email",newsletter:"Email",social:"Social Media","social-organic":"Social Media",affiliate:"Affiliates",partner:"Affiliates",organic:"Organic Search",referral:"Referral",direct:"Direct"}[e.toLowerCase()]||"Other"}async function E(){const e=function(){const e={userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,screenResolution:`${screen.width}x${screen.height}`,screenDepth:screen.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};return Object.values(e).join("|")}();let t=sessionStorage.getItem(w);if(t)return console.log("Returning visitor from session:",t),{id:t,fingerprint:e,isNew:!1};if(t=localStorage.getItem(w),t)return console.log("Returning visitor from local storage:",t),sessionStorage.setItem(w,t),await b({id:t,last_seen_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"visitors","PATCH"),{id:t,fingerprint:e,isNew:!1};const i={first_fingerprint_id:e,first_seen_at:(new Date).toISOString(),last_seen_at:(new Date).toISOString(),additional_fingerprints:[]},n=await b(i,"visitors");return n&&n[0]?.id?(t=n[0].id,sessionStorage.setItem(w,t),localStorage.setItem(w,t),console.log("New visitor created:",t),{id:t,fingerprint:e,isNew:!0}):(console.error("Failed to create or identify visitor"),null)}async function T(t,i={}){const n={session_id:sessionStorage.getItem(h),event_type:"error",event_timestamp:(new Date).toISOString(),page_url:e.location.href,element_type:null,element_id:null,other_data:JSON.stringify({error_message:t.message,error_stack:t.stack,...i,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})};try{await b([n],"events"),s.debug&&console.log("Error logged:",n)}catch(e){console.error("Failed to log error:",e);const t=JSON.parse(localStorage.getItem("failed_error_logs")||"[]");t.push(n),localStorage.setItem("failed_error_logs",JSON.stringify(t))}}function D(e){if(!e)return console.error("Event data is undefined"),!1;const t=["session_id","visitor_id","event_type","event_timestamp","page_url"].filter((t=>!e[t]));if(t.length>0)return console.error(`Missing required event fields: ${t.join(", ")}`),!1;if("string"!=typeof e.event_type)return console.error("event_type must be a string"),!1;if("string"!=typeof e.page_url||!e.page_url.startsWith("http"))return console.error("Invalid page_url format"),!1;try{new Date(e.event_timestamp).toISOString()}catch(e){return console.error("Invalid event_timestamp format"),!1}return!e.other_data||"string"==typeof e.other_data||(console.error("other_data must be a JSON string"),!1)}async function $(t,i=null,n=null,r={}){try{let a=sessionStorage.getItem(h);const o=sessionStorage.getItem(w);if(!a&&(a=await z(),!a))throw new Error("Failed to create/retrieve session");const s={event_type:t,event_timestamp:(new Date).toISOString(),page_url:e.location.href,element_type:i,element_id:n,visitor_id:o,session_id:a,other_data:JSON.stringify({integration_data:r,page_data:{title:document.title,path:e.location.pathname,referrer:document.referrer},interaction_data:{tab_active:m,time_since_last_activity:u?Math.round((new Date-u)/1e3):0,active_tab_time:Math.round(0),session_ending:d},client_data:{viewport:{width:e.innerWidth,height:e.innerHeight},scroll_depth:l,device_type:I()}})};if(!D(s))throw new Error("Invalid event data structure");f.push(s),f.length>=10?(clearTimeout(p),await C()):(clearTimeout(p),p=setTimeout(C,5e3))}catch(n){await T(n,{event_type:t,element_type:i,page_url:e.location.href})}}let P=0,A=Date.now();function M(e){const t=e.outerHTML.toLowerCase();return t.includes("contact")||e.id?.toLowerCase().includes("contact")?"contact":t.includes("subscribe")||t.includes("newsletter")?"newsletter":t.includes("demo")||t.includes("trial")?"demo":"other"}const C=async()=>{if(0!==f.length)try{const e=[...f];f.length=0;const t=e.filter((e=>{try{return D(e)}catch(e){return console.error("Event validation error:",e),!1}}));if(0===t.length)return void console.error("No valid events to process");const i=[];for(let e=0;e<t.length;e+=s.batchSize)i.push(t.slice(e,e+s.batchSize));for(const e of i)try{const t=e.map(((e,t)=>({event_type:e.event_type,event_timestamp:e.event_timestamp,page_url:e.page_url,element_type:e.element_type,element_id:e.element_id,visitor_id:e.visitor_id,session_id:e.session_id,other_data:e.other_data})));await b(t,"events"),s.debug&&console.log(`Processed batch of ${e.length} events`),s.batchDelay&&i.indexOf(e)!==i.length-1&&await new Promise((e=>setTimeout(e,s.batchDelay)))}catch(t){console.error("Error processing batch:",t),f.push(...e),await T(t,{context:"batch_processing",batch_size:e.length})}}catch(e){console.error("Error in queue processing:",e),f.push(...events),await T(e,{context:"event_queue_processing",queue_size:events.length})}};async function z(){try{const t=await E();if(!t||!t.id)throw new Error("Failed to identify visitor");sessionStorage.setItem(w,t.id),localStorage.setItem(w,t.id);const i=sessionStorage.getItem(h),n=sessionStorage.getItem(y);if(i&&n&&Date.now()-new Date(n).getTime()<60*s.sessionTimeout*1e3)return i;const r=function(){const e=sessionStorage.getItem("utm_params");if(e){const t=JSON.parse(e);if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:O(t.utm_medium)}}const t=k();if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:O(t.utm_medium)};const i=document.referrer;if(!i)return{source:"direct",medium:"none",channel:"direct"};try{const e=new URL(i).hostname,t={google:{medium:"organic",channel:"Organic Search"},bing:{medium:"organic",channel:"Organic Search"},yahoo:{medium:"organic",channel:"Organic Search"},duckduckgo:{medium:"organic",channel:"Organic Search"}},n={"facebook.com":{medium:"social",channel:"Social Media"},"instagram.com":{medium:"social",channel:"Social Media"},"linkedin.com":{medium:"social",channel:"Social Media"},"twitter.com":{medium:"social",channel:"Social Media"},"t.co":{medium:"social",channel:"Social Media"},"tiktok.com":{medium:"social",channel:"Social Media"}};for(const[i,n]of Object.entries(t))if(e.includes(i))return{source:i.charAt(0).toUpperCase()+i.slice(1),medium:n.medium,channel:n.channel};for(const[t,i]of Object.entries(n))if(e.includes(t))return{source:t.split(".")[0].charAt(0).toUpperCase()+t.split(".")[0].slice(1),medium:i.medium,channel:i.channel};return{source:e,medium:"referral",channel:"Referral"}}catch(e){return console.error("Error parsing referrer:",e),{source:"direct",medium:"none",channel:"direct"}}}(),a=k(),o={fingerprint_id:t.fingerprint,visitor_id:t.id,session_start:(new Date).toISOString(),entry_page_url:e.location.href,traffic_source:r.source,traffic_medium:r.medium,traffic_channel:r.channel,device_type:I(),country:Intl.DateTimeFormat().resolvedOptions().timeZone,click_id:a.click_id||null},d=await b(o,"sessions");if(!d?.[0]?.id)throw new Error("Failed to create session");const u=d[0].id;return sessionStorage.setItem(h,u),sessionStorage.setItem(y,o.session_start),await async function(t){try{if(!t)throw new Error("Session ID is required for UTM parameters");const i=function(){const t=new URLSearchParams(e.location.search),i={utm_source:t.get("utm_source"),utm_medium:t.get("utm_medium"),utm_campaign:t.get("utm_campaign"),utm_term:t.get("utm_term"),utm_content:t.get("utm_content")},n={gclid:t.get("gclid"),fbclid:t.get("fbclid"),ttclid:t.get("ttclid"),msclkid:t.get("msclkid")},r=Object.entries(n).find((([e,t])=>t))?.[1]||null,a=Object.entries(n).find((([e,t])=>t))?.[0]||null;return{...i,click_id:r,click_id_type:a,hasParameters:Object.values(i).some(Boolean)||null!==r}}();if(i.hasParameters){const e={session_id:t,utm_source:i.utm_source||null,utm_medium:i.utm_medium||null,utm_campaign:i.utm_campaign||null,utm_term:i.utm_term||null,utm_content:i.utm_content||null};Object.keys(e).forEach((t=>{null===e[t]&&delete e[t]}));try{if(Object.keys(e).length>1){!function(e){if(!e.session_id)throw new Error("Missing required field: session_id");const t=["session_id","utm_source","utm_medium","utm_campaign","utm_term","utm_content"],i=Object.keys(e).filter((e=>!t.includes(e)));if(i.length>0)throw new Error(`Invalid fields found: ${i.join(", ")}`);Object.entries(e).forEach((([e,t])=>{if("session_id"!==e&&null!==t&&"string"!=typeof t)throw new Error(`Invalid ${e} format: must be string or null`)}))}(e),await b(e,"utmparameters");const t=sessionStorage.getItem(w);if(t){const e={visitor_id:t,touchpoint_type:"attribution",source_type:i.utm_source||"direct",occurred_at:(new Date).toISOString(),metadata:JSON.stringify({utm_data:{source:i.utm_source,medium:i.utm_medium,campaign:i.utm_campaign,term:i.utm_term,content:i.utm_content},click_id:i.click_id,click_id_type:i.click_id_type,attribution_type:"utm_parameters",channel:O(i.utm_medium)})};await b(e,"touchpoints")}}}catch(t){console.error("Failed to store UTM parameters:",t),await T(t,{context:"utm_parameter_tracking",utm_data:e})}}}catch(e){throw await T(e,{context:"utm_handling"}),e}}(u),await async function(t,i){try{if(!t||!i)throw new Error("Session ID and page URL are required");let n=sessionStorage.getItem(w);if(!n){console.error("No visitor ID found when recording pagevisit");const e=await E();if(!e?.id)throw new Error("Failed to identify visitor");n=e.id,sessionStorage.setItem(w,n)}const r=await b(null,`sessions?id=eq.${t}&select=visitor_id`,"GET");if(!r?.[0]||r[0].visitor_id!==n)throw new Error("Session-visitor mismatch");const a={session_id:t,visitor_id:n,page_url:i,visit_timestamp:(new Date).toISOString(),page_type:j(L(i)),sequence_number:Date.now(),page_title:document.title,page_path:e.location.pathname,referrer:document.referrer,viewport_width:e.innerWidth,viewport_height:e.innerHeight,browser_language:navigator.language,metadata:JSON.stringify({page_data:{hash:e.location.hash,search:e.location.search},client_data:{device_type:I(),user_agent:navigator.userAgent,platform:navigator.platform,screen_resolution:`${screen.width}x${screen.height}`},performance_data:{connection_type:navigator.connection?.effectiveType||null,connection_speed:navigator.connection?.downlink||null}})};if(!a.visitor_id?.match(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i))throw new Error("Invalid visitor_id format");if(!a.session_id?.match(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i))throw new Error("Invalid session_id format");!function(e){const t=["session_id","visitor_id","page_url","visit_timestamp"].filter((t=>!e[t]));if(t.length>0)throw new Error(`Missing required pagevisit fields: ${t.join(", ")}`);if(!e.page_url.startsWith("http"))throw new Error("Invalid page_url format")}(a),s.debug&&console.log("Recording page visit:",{visitor_id:n,session_id:t,page_url:i});const o=await b(a,"pagevisits");return c=new Date,l=0,o}catch(e){return await T(e,{context:"page_visit_recording",page_url:i,session_id:t,visitor_attempt:sessionStorage.getItem(w)}),null}}(u,e.location.href),s.debug&&console.log("Tracking initialized with session:",u),u}catch(e){return console.error("Error in startTracking:",e),await T(e,{context:"start_tracking"}),null}}async function N(t={}){try{if(!t.apiKey&&!n.apiKey)throw new Error("API key is required for initialization");if(s={...n,...t},!s.supabaseUrl||!s.supabaseKey)throw new Error("Supabase URL and API key are required");if(!await z())throw new Error("Failed to initialize tracking session");document.addEventListener("submit",(async function(t){try{let i=sessionStorage.getItem(h);if(!i&&(i=await z(),!i))return void console.error("Failed to create session for form submission");const n=t.target,r=Array.from(n.elements).find((e=>"email"===e.type||e.name?.toLowerCase().includes("email")||e.id?.toLowerCase().includes("email"))),o=Array.from(n.elements).find((e=>e.name?.toLowerCase().includes("company")||e.name?.toLowerCase().includes("organization")||e.id?.toLowerCase().includes("company")||e.id?.toLowerCase().includes("organization"))),c=r?.value?.trim(),l=o?.value?.trim();let d=null,u=!1;c&&(d=c.split("@")[1]?.toLowerCase(),u=d&&!_.includes(d));const m=sessionStorage.getItem(w);if(c&&m){const e=await async function(e,t){try{const i=new Date(Date.now()-3e5),n=`${s.supabaseUrl}/rest/v1/form_submissions`,r=await fetch(`${n}?visitor_id=eq.${e}&email=eq.${t}&submission_timestamp=gte.${i.toISOString()}&select=id&limit=1`,{headers:{Authorization:`Bearer ${s.supabaseKey}`,apikey:s.supabaseKey}});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const a=await r.json();return a&&a.length>0}catch(e){return console.error("Error checking recent submissions:",e),!1}}(m,c);if(e)return console.log("Please wait before submitting again"),void t.preventDefault()}const g=e.location.href,f=n.action,p=a(g),y=a(f),v=function(e){try{const t=new URL(e),i={};t.searchParams.forEach(((e,t)=>{i[t]=e}));const n={gclid:t.searchParams.get("gclid"),fbclid:t.searchParams.get("fbclid"),ttclid:t.searchParams.get("ttclid"),msclkid:t.searchParams.get("msclkid")};return Object.entries(n).forEach((([e,t])=>{t&&(i[e]=t)})),i}catch(e){return{}}}(g);if(c&&m){const e={id:m,email:c,email_domain:d,is_identified:!0,identification_date:(new Date).toISOString(),identification_source:"form_submission",is_anonymous:!1,updated_at:(new Date).toISOString()};try{await b(e,"visitors","PATCH"),console.log("Visitor identified:",m),u&&await async function(e,t,i,n){try{const r=await async function(e){try{const t=await fetch(`${s.supabaseUrl}/rest/v1/companies?domain=eq.${e}&select=id`,{headers:{Authorization:`Bearer ${s.supabaseKey}`,apikey:s.supabaseKey}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json())[0]}catch(e){return console.error("Error finding company:",e),null}}(e);if(r)await b({id:r.id,last_enrichment_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"companies","PATCH"),await b({id:i,company_id:r.id,updated_at:(new Date).toISOString()},"visitors","PATCH");else{const r={domain:e,name:t||e.split(".")[0],identified_via:"form_submission",identified_at:(new Date).toISOString(),status:"identified",company_data:JSON.stringify({first_visitor_id:i,first_seen_email:n})},a=await b(r,"companies");a?.[0]?.id&&await b({id:i,company_id:a[0].id,updated_at:(new Date).toISOString()},"visitors","PATCH")}}catch(e){console.error("Error handling company identification:",e)}}(d,l,m,c);const t={visitor_id:m,touchpoint_type:"identification",source_type:"form_submission",occurred_at:(new Date).toISOString(),metadata:JSON.stringify({email_domain:d,is_business_email:u,form_name:n.getAttribute("name")||n.id||"unnamed_form",identification_method:"form_email"})};await b(t,"touchpoints")}catch(e){await T(e,{context:"visitor_identification",visitorId:m,email_domain:d})}}const S={session_id:i,visitor_id:m,form_id:n.id||null,form_name:n.getAttribute("name")||null,form_action:n.action,page_url:g,clean_page_url:p,clean_form_action:y,url_parameters:v,email_domain:d,email:c,is_business_email:u,submission_timestamp:(new Date).toISOString(),form_fields:JSON.stringify({has_company_field:!!o,has_email_field:!!r,company_name:l||null,fields:Array.from(n.elements).filter((e=>e.name&&!e.name.toLowerCase().includes("password"))).map((e=>({name:e.name,type:e.type,required:e.required,has_value:!!e.value})))}),metadata:JSON.stringify({form_type:M(n),field_count:n.elements.length,has_required_fields:Array.from(n.elements).some((e=>e.required)),page_title:document.title,url_path:e.location.pathname,device_type:I()})};!function(e){const t=["session_id","visitor_id","submission_timestamp"].filter((t=>!e[t]));if(t.length>0)throw new Error(`Missing required form fields: ${t.join(", ")}`)}(S);try{const e=await b(S,"form_submissions");if(e?.[0]?.id){const t={visitor_id:m,touchpoint_type:"form_submission",source_type:"web_form",source_id:e[0].id,occurred_at:(new Date).toISOString(),metadata:JSON.stringify({form_type:M(n),form_name:S.form_name,is_business_email:u,has_company_field:!!o})};await b(t,"touchpoints")}await $("form_complete","FORM",n.id,{formType:M(n),hasEmail:!!r,hasCompany:!!o,isBusinessEmail:u,formName:S.form_name,fieldCount:n.elements.length})}catch(e){await T(e,{context:"form_submission",formId:n.id,sessionId:i})}}catch(e){await T(e,{context:"form_tracking"})}})),document.addEventListener("change",(async function(e){const t=e.target;t.form&&await $("form_field_complete",t.tagName,t.id,{fieldType:t.type,fieldName:t.name,isRequired:t.required,formId:t.form.id,formType:M(t.form),hasValue:!!t.value,isValid:t.checkValidity(),fieldPosition:Array.from(t.form.elements).indexOf(t)}).catch((e=>{T(e,{context:"field_change",fieldId:t.id,fieldName:t.name})}))})),document.addEventListener("click",(function(e){const t=e.target.closest("a");if(!t)return;const i=t.href||"";[".pdf",".doc",".docx",".xls",".xlsx",".zip",".rar"].some((e=>i.toLowerCase().endsWith(e)))&&$("file_download","LINK",t.id,{fileName:i.split("/").pop(),fileType:i.split(".").pop().toLowerCase()})})),document.addEventListener("play",(function(e){"VIDEO"===e.target.tagName&&$("video_play","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,videoDuration:e.target.duration})}),!0),document.addEventListener("pause",(function(e){"VIDEO"===e.target.tagName&&$("video_pause","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,timeStamp:e.target.currentTime})}),!0),function(){let t=0;const i=function(e){let t;return function(...i){clearTimeout(t),t=setTimeout((()=>e.apply(this,i)),200)}}((function(){const i=function(){const t=e.innerHeight,i=document.documentElement.scrollHeight,n=e.pageYOffset||document.documentElement.scrollTop;return Math.round((n+t)/i*100)}();if(i>l){l=i;const e=25*Math.floor(i/25);e>t&&($("scroll_depth",null,null,{depth:e}),t=e)}}));e.addEventListener("scroll",i),e.addEventListener("beforeunload",(()=>{l>0&&$("final_scroll_depth",null,null,{depth:l})}))}(),document.addEventListener("visibilitychange",(()=>{m="visible"===document.visibilityState,m&&(u=new Date,d&&(d=!1,console.log("Session restored due to user activity")))})),["mousedown","keydown","scroll","touchstart"].forEach((e=>{document.addEventListener(e,(()=>{u=new Date,d&&(d=!1,console.log("Session restored due to user activity"))}))})),o=setInterval((()=>{if(!m)return;const e=(new Date-u)/1e3/60;e>=10&&!d&&(d=!0,$("session_inactive",null,null,{inactiveTime:e}))}),6e4),setInterval((function(){if(m){const e=Date.now();P+=e-A,A=e}}),1e3),setInterval((function(){m&&$("page_time_checkpoint",null,null,{activeTime:Math.round(P/1e3),totalTime:Math.round((Date.now()-c)/1e3)})}),3e5),setInterval((async()=>{if(navigator.onLine)try{const e=JSON.parse(localStorage.getItem("failed_events")||"[]");if(0===e.length)return;const t=[];for(const i of e)try{"final_scroll_depth"===i.type?await $("recovered_scroll_depth",null,null,{...i.data,recovered:!0,original_timestamp:i.timestamp}):await b(i.data,i.table,i.method),t.push(i)}catch(e){console.error("Failed to recover event:",{error:e.message,event:i}),await T(e,{context:"event_recovery",event_data:i})}localStorage.setItem("failed_events",JSON.stringify(e.filter((e=>!t.includes(e)))))}catch(e){console.error("Error in failed event recovery:",{error:e.message}),await T(e,{context:"failed_event_recovery"})}}),6e4),function(){if(e.MktoForms2){const e=document.createElement("script");e.async=!0,e.crossOrigin="anonymous",e.src="https://cdn.jsdelivr.net/gh/metricpalai/tracking-script@latest/mkto.js",e.onerror=()=>console.error("Failed to load Marketo integration"),document.head.appendChild(e)}if(document.querySelector('script[src*="hubspot"]')){const e=document.createElement("script");e.async=!0,e.crossOrigin="anonymous",e.src="https://cdn.jsdelivr.net/gh/metricpalai/tracking-script@latest/hubspot.js",e.onerror=()=>console.error("Failed to load HubSpot integration"),document.head.appendChild(e)}}(),document.addEventListener("click",(function(e){const t=e.target.closest('a, button, [role="button"], input[type="submit"]');if(t){const e={type:t.tagName.toLowerCase(),id:t.id||"",text:t.innerText||t.value||"",href:t.href||"",classes:t.className};(t.closest("[data-track]")||e.href||"submit"===e.type||e.classes.includes("cta")||e.classes.includes("btn-primary"))&&$("click",e.type,e.id,{text:e.text,href:e.href})}}))}catch(e){console.error("Fatal initialization error:",e)}}if(e.MetricPal={init:async function(t){try{await N(t),this.initialized=!0,e.ClientTracker&&(e.ClientTracker.initialized=!0)}catch(e){throw console.error("Error initializing MetricPal:",e),e}},track:function(e,t){this.initialized?$(e,null,null,t):console.error("MetricPal must be initialized before tracking events")},initialized:!1},e.initializeClientTracker=function(t){return e.MetricPal.init(t)},e.ClientTracker={init:e.initializeClientTracker,track:function(t,i){e.MetricPal.initialized?$(t,null,null,i):console.error("Tracker must be initialized before tracking events")},initialized:!1},e.google_tag_manager)try{const t=e.dataLayer?.find((e=>e.trackerConfig))?.trackerConfig;t&&e.MetricPal.init(t)}catch(e){console.error("GTM initialization error:",e)}function L(e){try{const t=new URL(e).pathname.toLowerCase(),i={home:/^\/$/,blog:/^\/blog(\/.*)?$/,product:/^\/products?(\/.*)?$/,category:/^\/categor(y|ies)(\/.*)?$/,contact:/^\/contact(-us)?$/,about:/^\/about(-us)?$/,pricing:/^\/pricing$/,checkout:/^\/checkout(\/.*)?$/,cart:/^\/cart$/,account:/^\/account(\/.*)?$/,search:/^\/search$/,legal:/^\/(terms|privacy|cookies)(\/.*)?$/};for(const[e,n]of Object.entries(i))if(n.test(t))return e;if(t.match(/^\/[a-z0-9-]+\/p\/[a-z0-9-]+$/))return"product";if(t.match(/^\/[a-z0-9-]+\/c\/[a-z0-9-]+$/))return"category";const n=document.querySelector('meta[name="page-type"]');return n?.content?n.content.toLowerCase():"other"}catch(e){return r("Error detecting page type:",e),"other"}}function j(e){return["home","blog","product","category","contact","about","pricing","checkout","cart","account","search","legal","other"].includes(e)?e:(r(`Invalid page type detected: ${e}. Defaulting to 'other'`),"other")}i&&e.MetricPal.init({apiKey:i}),e.addEventListener("beforeunload",(function(){const t=sessionStorage.getItem("mp_session_id");if(!t)return;console.log("Session ending, tracking session end data..."),$("page_time_summary",null,null,{activeTime:Math.round(P/1e3),totalTime:Math.round((Date.now()-c)/1e3),isActive:m}),$("final_scroll_depth",null,null,{depth:l});const i={id:t,session_end:(new Date).toISOString(),exit_page_url:e.location.href,other_data:JSON.stringify({total_active_time:Math.round(P/1e3),total_time:Math.round((Date.now()-c)/1e3),final_scroll_depth:l,tab_switches:0,last_active:u.toISOString(),inactivity_periods:g,is_tab_active:m,device_info:{userAgent:navigator.userAgent,screenSize:`${e.screen.width}x${e.screen.height}`,viewportSize:`${e.innerWidth}x${e.innerHeight}`}})};try{navigator.sendBeacon(`${s.supabaseUrl}/rest/v1/sessions?id=eq.${t}`,JSON.stringify({...i,headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.supabaseKey}`,apikey:s.supabaseKey,Prefer:"return=minimal"}})),console.log("Session end data successfully sent using sendBeacon.")}catch(e){console.error("Failed to send session end data using sendBeacon:",e)}}))}(window);
